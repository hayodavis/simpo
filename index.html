<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPO: Ultimate Duel (Cloud Connected)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #020617;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        .font-moba { font-family: 'Orbitron', sans-serif; }

        /* --- Animations --- */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        @keyframes shoot-p1 {
            0% { left: 15%; opacity: 1; transform: scale(1) rotate(0deg); }
            80% { opacity: 1; }
            100% { left: 85%; opacity: 0; transform: scale(2) rotate(360deg); }
        }

        @keyframes shoot-p2 {
            0% { right: 15%; opacity: 1; transform: scale(1) rotate(0deg); }
            80% { opacity: 1; }
            100% { right: 85%; opacity: 0; transform: scale(2) rotate(-360deg); }
        }

        @keyframes damagePopup {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.2); }
        }

        @keyframes arenaFade {
            0% { opacity: 0; transform: scale(0.5); }
            20% { opacity: 1; transform: scale(1.2); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        @keyframes ult-glow {
            0% { box-shadow: 0 0 10px #facc15; transform: scale(1); }
            50% { box-shadow: 0 0 30px #facc15; transform: scale(1.05); }
            100% { box-shadow: 0 0 10px #facc15; transform: scale(1); }
        }

        @keyframes screen-shake {
            0% { transform: translate(0, 0); } 10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); } 30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); } 50% { transform: translate(-10px, -10px); }
            60% { transform: translate(10px, 10px); } 70% { transform: translate(-10px, 10px); }
            80% { transform: translate(10px, -10px); } 90% { transform: translate(0, 0); }
            100% { transform: translate(0, 0); }
        }

        @keyframes thunder-flash {
            0% { background-color: rgba(255, 255, 255, 0); }
            10% { background-color: rgba(34, 211, 238, 0.8); }
            20% { background-color: rgba(255, 255, 255, 0); }
            30% { background-color: rgba(34, 211, 238, 0.8); }
            100% { background-color: rgba(255, 255, 255, 0); }
        }

        @keyframes meteor-flash {
            0% { background-color: rgba(255, 255, 255, 0); }
            10% { background-color: rgba(239, 68, 68, 0.8); }
            50% { background-color: rgba(239, 68, 68, 0.4); }
            100% { background-color: rgba(255, 255, 255, 0); }
        }

        @keyframes urgentPulse {
            0% { stroke: #ef4444; opacity: 1; }
            50% { stroke: #fee2e2; opacity: 0.5; }
            100% { stroke: #ef4444; opacity: 1; }
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes danger-pulse {
            0% { box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3); }
            50% { box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.8); }
            100% { box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.3); }
        }

        .hero-float { animation: float 3s ease-in-out infinite; }
        
        /* UI Components */
        .glass-panel {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(56, 189, 248, 0.4);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        .mode-card {
            transition: all 0.3s;
            cursor: pointer;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            border-color: #22d3ee;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }

        .skill-btn {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            transition: all 0.1s;
        }
        .skill-btn:active { transform: scale(0.95); background: #334155; }
        .skill-btn:disabled { filter: grayscale(1); opacity: 0.5; }

        .ult-btn {
            background: linear-gradient(135deg, #4b5563, #1f2937);
            border: 2px solid #6b7280;
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed;
            transition: all 0.3s;
        }
        .ult-btn.ready {
            filter: grayscale(0);
            opacity: 1;
            cursor: pointer;
            background: linear-gradient(135deg, #fbbf24, #b45309);
            border-color: #fde047;
            animation: ult-glow 1.5s infinite;
        }
        .ult-btn.ready:active { transform: scale(0.95); }

        .health-bar-container { background: #334155; border: 2px solid #000; }
        .health-fill { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        .projectile {
            position: absolute;
            top: 35%; 
            font-size: 4rem;
            z-index: 50;
            display: none;
            pointer-events: none;
        }

        .hud-hexagon {
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            background: linear-gradient(180deg, #334155, #0f172a);
            border: 2px solid #eab308;
            z-index: 20;
        }
        
        .timer-svg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            width: 110px; height: 110px;
            z-index: 10; pointer-events: none;
        }
        
        .timer-circle {
            fill: none; stroke-width: 6; stroke-linecap: round;
            stroke-dasharray: 283; stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear, stroke 0.3s;
        }

        .score-box {
            background: rgba(0,0,0,0.6);
            transform: skewX(-20deg);
            border-bottom: 2px solid;
        }
        .score-content { transform: skewX(20deg); }

        .briefing-card {
            background: linear-gradient(180deg, rgba(15,23,42,0.95) 0%, rgba(30,58,138,0.9) 100%);
            border: 2px solid #22d3ee;
            box-shadow: 0 0 50px rgba(34,211,238,0.3);
            position: relative;
            overflow: hidden;
        }
        .briefing-scanline {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(34,211,238,0.1) 51%, transparent 51%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        /* Character Select Styles */
        .char-btn {
            border: 2px solid #334155;
            background: #1e293b;
            transition: all 0.2s;
            cursor: pointer;
        }
        .char-btn:hover { border-color: #94a3b8; }
        .char-btn.selected-p1 {
            border-color: #22d3ee;
            background: rgba(34, 211, 238, 0.2);
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.5);
        }
        .char-btn.selected-p2 {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        
        .control-btn {
            @apply w-10 h-10 bg-slate-800 border border-slate-600 rounded-full flex items-center justify-center hover:bg-slate-700 transition shadow-lg;
        }

        /* Leaderboard Table */
        .rank-1 { color: #fbbf24; text-shadow: 0 0 10px #fbbf24; }
        .rank-2 { color: #94a3b8; text-shadow: 0 0 10px #94a3b8; }
        .rank-3 { color: #b45309; text-shadow: 0 0 10px #b45309; }

        /* Rank Tabs */
        .rank-tab {
            @apply px-6 py-3 rounded-t-lg font-bold text-sm tracking-widest transition-all border-b-4 border-slate-700 text-slate-500 hover:text-white bg-slate-800/50 uppercase flex-1;
        }
        .rank-tab.active-single {
            @apply text-cyan-400 border-cyan-400 bg-slate-800 shadow-[0_-5px_15px_rgba(34,211,238,0.2)];
        }
        .rank-tab.active-multi {
            @apply text-red-400 border-red-500 bg-slate-800 shadow-[0_-5px_15px_rgba(239,68,68,0.2)];
        }

        /* Leaderboard Rows */
        .leaderboard-row {
            @apply border-b border-slate-600 bg-slate-800/40 hover:bg-slate-700/60 transition-colors duration-200;
        }
        .leaderboard-row:last-child {
            border-bottom: none;
        }
        .leaderboard-cell {
            @apply p-4 border-r border-slate-700/50 last:border-r-0;
        }

        /* Low HP Overlay (FIXED) */
        .critical-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            /* Remove display: none to allow JS to control 'hidden' class */
            /* Z-index 15 puts it above sprites (z-10) but below HUD (z-20) */
            z-index: 15; 
            animation: danger-pulse 1s infinite;
            background: radial-gradient(circle, transparent 60%, rgba(255, 0, 0, 0.4) 100%);
        }
    </style>
</head>
<body class="h-screen w-full bg-black overflow-hidden relative" onload="initGameData()">

    <div id="ult-overlay" class="absolute inset-0 z-[60] pointer-events-none hidden"></div>

    <!-- AUDIO CONTROLS -->
    <div class="absolute top-4 right-4 z-[70] flex gap-2">
        <button onclick="toggleMusic()" id="bgm-btn" class="control-btn" title="Toggle Music">
            <i class="fas fa-music text-slate-400"></i> 
        </button>
        <button onclick="toggleMute()" id="mute-btn" class="control-btn" title="Toggle SFX">
            <i class="fas fa-volume-up text-cyan-400"></i>
        </button>
    </div>

    <!-- 1. LOADING SCREEN -->
    <div id="screen-loading" class="absolute z-[80] inset-0 bg-slate-900 flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-2xl font-moba text-white animate-pulse">CONNECTING TO SYSTEM...</h2>
        <p id="loading-status" class="text-slate-400 mt-2 text-sm font-mono">Initializing Game Data (15s Timeout)</p>
    </div>

    <!-- 2. MODE SELECTION -->
    <div id="screen-mode" class="hidden absolute z-50 inset-0 bg-[url('https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=2071')] bg-cover bg-center flex flex-col items-center justify-center">
        <div class="absolute inset-0 bg-slate-950/90"></div>
        
        <!-- ADMIN SHORTCUT (Hidden Button) -->
        <button onclick="adminLogin()" class="absolute top-4 left-4 z-[70] w-8 h-8 opacity-20 hover:opacity-100 transition text-slate-400 hover:text-white" title="Admin Login">
            <i class="fas fa-lock"></i>
        </button>
        
        <!-- Connection Status Indicator -->
        <div class="absolute top-4 left-14 z-[70] flex items-center gap-2 bg-black/60 px-3 py-1 rounded border border-slate-700" id="connection-indicator">
            <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse" id="conn-dot"></div>
            <span class="text-xs font-mono text-slate-300" id="conn-text">CHECKING...</span>
        </div>

        <div class="relative z-10 text-center w-full max-w-5xl px-4">
            <h1 class="text-6xl md:text-8xl font-moba text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2 drop-shadow-[0_0_15px_rgba(6,182,212,0.8)]">SIMPO</h1>
            <p class="text-xl text-slate-300 mb-8 tracking-[0.3em] uppercase">Ultimate Edition</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div onclick="selectMode('single')" class="mode-card glass-panel p-8 rounded-2xl border border-slate-700 group">
                    <div class="w-24 h-24 bg-slate-800 rounded-full mx-auto mb-4 flex items-center justify-center border-2 border-slate-600 group-hover:border-cyan-400">
                        <i class="fas fa-user-astronaut text-4xl text-cyan-400"></i>
                    </div>
                    <h2 class="text-3xl font-moba text-white mb-2">SOLO ADVENTURE</h2>
                    <p class="text-slate-400 text-sm">Lawan Bug Abyssal sendirian.</p>
                </div>
                <div onclick="selectMode('multi')" class="mode-card glass-panel p-8 rounded-2xl border border-slate-700 group">
                    <div class="w-24 h-24 bg-slate-800 rounded-full mx-auto mb-4 flex items-center justify-center border-2 border-slate-600 group-hover:border-red-500">
                        <div class="flex gap-2"><i class="fas fa-user text-3xl text-cyan-400"></i><i class="fas fa-user text-3xl text-red-500"></i></div>
                    </div>
                    <h2 class="text-3xl font-moba text-white mb-2">PVP DUEL (1 vs 1)</h2>
                    <p class="text-slate-400 text-sm">Duel di satu layar IFP.</p>
                </div>
            </div>

            <!-- Leaderboard Button -->
            <button onclick="showLeaderboard()" class="px-8 py-3 bg-slate-800 border border-yellow-600 text-yellow-400 rounded-full font-bold hover:bg-slate-700 transition flex items-center justify-center gap-2 mx-auto shadow-[0_0_15px_rgba(234,179,8,0.3)]">
                <i class="fas fa-trophy"></i> HALL OF FAME
            </button>
        </div>
    </div>

    <!-- LEADERBOARD SCREEN (Updated) -->
    <div id="screen-leaderboard" class="hidden absolute z-[60] inset-0 bg-slate-950/95 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
        <div class="w-full max-w-4xl glass-panel p-1 rounded-2xl relative flex flex-col max-h-[90vh] border-2 border-slate-500 shadow-2xl">
            <!-- Header -->
            <div class="flex justify-between items-center p-6 pb-4 bg-slate-900/80 rounded-t-xl border-b border-slate-600">
                <div class="flex items-center gap-3">
                    <i class="fas fa-trophy text-4xl text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]"></i>
                    <div>
                        <h2 class="text-3xl font-moba text-white tracking-widest">HALL OF FAME</h2>
                        <p id="leaderboard-subtitle" class="text-xs text-slate-400 font-mono uppercase tracking-widest">Global Rankings</p>
                    </div>
                </div>
                <button onclick="hideLeaderboard()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 hover:bg-red-900/50 text-slate-400 hover:text-red-400 transition border border-slate-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex px-4 pt-4 gap-2 bg-slate-900/50">
                <button onclick="fetchRankData('single')" id="tab-single" class="rank-tab active-single rounded-t-xl border-x border-t border-slate-600">
                    <i class="fas fa-user-astronaut mr-2"></i>SOLO RANK
                </button>
                <button onclick="fetchRankData('multi')" id="tab-multi" class="rank-tab rounded-t-xl border-x border-t border-slate-600">
                    <i class="fas fa-users mr-2"></i>DUEL RANK
                </button>
            </div>

            <!-- Table Container -->
            <div class="flex-grow overflow-y-auto custom-scrollbar bg-slate-900 m-4 mt-0 rounded-b-xl border border-slate-600 h-[400px]">
                <table class="w-full text-left border-collapse">
                    <thead class="text-slate-400 bg-slate-800 sticky top-0 z-10 text-xs font-bold uppercase tracking-wider shadow-md">
                        <tr>
                            <th class="p-4 border-r border-b border-slate-600 w-20 text-center">#</th>
                            <th class="p-4 border-r border-b border-slate-600">Player Name</th>
                            <th class="p-4 border-r border-b border-slate-600 text-right w-32">Score</th>
                            <th class="p-4 border-b border-slate-600 text-right w-36">Date</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="text-slate-300 font-mono text-sm divide-y divide-slate-700/50">
                        <tr><td colspan="4" class="text-center p-12 text-slate-500 animate-pulse">Select a category...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. CHARACTER & NAME INPUT -->
    <div id="screen-input" class="hidden absolute z-50 inset-0 bg-slate-900 flex flex-col items-center justify-center overflow-y-auto">
        <h2 class="text-4xl font-moba text-white mb-8 mt-10">SELECT HEROES</h2>
        
        <div class="flex flex-col md:flex-row gap-12 w-full max-w-6xl justify-center px-4 mb-8">
            <!-- P1 Config -->
            <div class="w-full max-w-md bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                <label class="block text-cyan-400 font-bold mb-4 text-center text-xl tracking-widest">PLAYER 1</label>
                <input type="text" id="input-p1" class="w-full bg-slate-900 border-2 border-cyan-500 rounded-lg p-3 text-center text-xl text-white mb-6 focus:outline-none focus:shadow-[0_0_20px_cyan]" placeholder="Enter Name" value="Hero">
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <div onclick="selectAvatar('p1', 0)" id="p1-char-0" class="char-btn selected-p1 rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">üßô‚Äç‚ôÇÔ∏è</div>
                    <div onclick="selectAvatar('p1', 1)" id="p1-char-1" class="char-btn rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">ü§ñ</div>
                    <div onclick="selectAvatar('p1', 2)" id="p1-char-2" class="char-btn rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">ü•∑</div>
                    <div onclick="selectAvatar('p1', 3)" id="p1-char-3" class="char-btn rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">üëΩ</div>
                </div>
                <p class="text-center text-xs text-slate-400">Select Avatar</p>
            </div>
            <!-- P2 Config -->
            <div id="p2-input-group" class="hidden w-full max-w-md bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                <label class="block text-red-500 font-bold mb-4 text-center text-xl tracking-widest">PLAYER 2</label>
                <input type="text" id="input-p2" class="w-full bg-slate-900 border-2 border-red-500 rounded-lg p-3 text-center text-xl text-white mb-6 focus:outline-none focus:shadow-[0_0_20px_red]" placeholder="Enter Name" value="Rival">
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <div onclick="selectAvatar('p2', 0)" id="p2-char-0" class="char-btn selected-p2 rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">üßô‚Äç‚ôÇÔ∏è</div>
                    <div onclick="selectAvatar('p2', 1)" id="p2-char-1" class="char-btn rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">ü§ñ</div>
                    <div onclick="selectAvatar('p2', 2)" id="p2-char-2" class="char-btn rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">ü•∑</div>
                    <div onclick="selectAvatar('p2', 3)" id="p2-char-3" class="char-btn rounded-lg p-2 text-center text-4xl h-20 flex items-center justify-center">üëΩ</div>
                </div>
                <p class="text-center text-xs text-slate-400">Select Avatar</p>
            </div>
        </div>
        <button onclick="startGame()" class="px-12 py-4 bg-gradient-to-r from-blue-600 to-cyan-500 rounded-lg font-bold text-xl hover:scale-105 transition shadow-lg mb-8">START BATTLE</button>
        <button onclick="location.reload()" class="text-slate-500 hover:text-white pb-8">Back</button>
    </div>

    <!-- 4. PRE-GAME BRIEFING -->
    <div id="screen-briefing" class="hidden absolute z-50 inset-0 bg-slate-950 flex flex-col items-center justify-center p-6">
        <div class="briefing-card w-full max-w-4xl p-8 rounded-2xl relative text-center">
            <div class="briefing-scanline"></div>
            <h3 class="text-cyan-400 text-sm uppercase tracking-[0.5em] mb-2 font-bold">Arena Data Downloaded</h3>
            <h2 id="briefing-title" class="text-5xl md:text-6xl font-moba text-white mb-8">ARENA NAME</h2>
            <div class="bg-black/50 border border-slate-600 p-6 rounded-xl mb-8">
                <p id="briefing-desc" class="text-xl md:text-2xl text-cyan-100 leading-relaxed font-mono">...</p>
            </div>
            <div class="flex flex-col items-center gap-4">
                <div class="w-full h-1 bg-slate-800 rounded overflow-hidden max-w-md">
                    <div id="briefing-timer-bar" class="h-full bg-yellow-400 w-full"></div>
                </div>
                <button onclick="endBriefing()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 rounded font-bold tracking-wider transition">START MISSION NOW</button>
                <p class="text-xs text-slate-500">Auto-start in <span id="briefing-countdown">8</span>s</p>
            </div>
        </div>
    </div>

    <!-- 5. GAME INTERFACE -->
    <div id="game-interface" class="hidden w-full h-full flex-col relative bg-slate-950">
        <!-- Dynamic Background Container -->
        <div id="arena-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-1000 opacity-50 pointer-events-none"></div>
        <div class="absolute inset-0 bg-[linear-gradient(rgba(30,58,138,0.1)_1px,transparent_1px),linear-gradient(90deg,rgba(30,58,138,0.1)_1px,transparent_1px)] bg-[size:40px_40px] pointer-events-none"></div>
        
        <!-- Low HP Critical Overlay (UPDATED) -->
        <div id="low-hp-overlay-p1" class="critical-overlay left-0 w-1/2 hidden"></div>
        <div id="low-hp-overlay-p2" class="critical-overlay right-0 w-1/2 hidden"></div>

        <!-- HEADER -->
        <div class="relative z-20 w-full h-24 flex items-start justify-center pt-2 gap-4 pointer-events-none">
            <div class="score-box w-64 h-16 border-cyan-500 flex items-center justify-end px-6 pr-12 shadow-[0_0_15px_rgba(6,182,212,0.3)] bg-gradient-to-r from-transparent to-slate-900">
                <div class="score-content text-right">
                    <div class="text-[10px] text-cyan-300 uppercase tracking-widest">Player 1</div>
                    <div class="text-3xl font-moba text-cyan-400 font-bold drop-shadow-[0_0_5px_cyan]" id="score-p1">0</div>
                </div>
            </div>
            <div class="relative z-30 -mt-2 flex flex-col items-center justify-center">
                <svg class="timer-svg" viewBox="0 0 100 100"><circle class="timer-circle" cx="50" cy="50" r="45" stroke="#22c55e" /></svg>
                <div class="hud-hexagon w-20 h-20 flex flex-col items-center justify-center bg-slate-800 text-yellow-400 shadow-lg relative">
                    <div class="text-[10px] font-bold opacity-70">TIME</div>
                    <div class="text-3xl font-moba font-bold" id="timer-text">20</div>
                </div>
                <div class="bg-black/80 border border-yellow-600 px-4 py-1 rounded-full -mt-4 relative z-40">
                    <span id="arena-name" class="text-xs text-yellow-400 font-bold uppercase tracking-wider whitespace-nowrap">Arena 1</span>
                </div>
            </div>
            <div class="score-box w-64 h-16 border-red-500 flex items-center justify-start px-6 pl-12 shadow-[0_0_15px_rgba(239,68,68,0.3)] bg-gradient-to-l from-transparent to-slate-900" id="p2-score-container">
                <div class="score-content text-left">
                    <div class="text-[10px] text-red-300 uppercase tracking-widest">Player 2</div>
                    <div class="text-3xl font-moba text-red-500 font-bold drop-shadow-[0_0_5px_red]" id="score-p2">0</div>
                </div>
            </div>
        </div>

        <!-- BATTLEFIELD -->
        <div class="relative flex-grow flex items-center justify-center overflow-hidden -mt-10" id="battlefield">
            <div id="arena-banner" class="absolute inset-0 flex items-center justify-center z-50 pointer-events-none opacity-0">
                <h1 id="arena-banner-text" class="text-6xl md:text-8xl font-moba text-yellow-400 drop-shadow-[0_0_30px_black] text-center bg-black/80 w-full py-10">ARENA START</h1>
            </div>
            
            <div id="combat-text-container" class="absolute inset-0 pointer-events-none z-50"></div>
            <div id="proj-p1" class="projectile text-cyan-400 drop-shadow-[0_0_20px_cyan]"><i class="fas fa-code"></i></div>
            <div id="proj-p2" class="projectile text-red-500 drop-shadow-[0_0_20px_red]"><i class="fas fa-bug"></i></div>
            <div id="vs-logo" class="absolute text-slate-800 text-[20vw] font-black opacity-20 select-none">VS</div>

            <!-- Single View -->
            <div id="view-single" class="hidden w-full h-full flex items-center justify-between px-20 relative z-10">
                <div class="relative text-center">
                    <div class="w-48 h-4 bg-slate-800 rounded border border-slate-600 mb-2 overflow-hidden"><div id="sp-hp-hero" class="h-full bg-cyan-500 w-full health-fill"></div></div>
                    <div class="text-9xl filter drop-shadow-[0_0_20px_cyan] hero-float" id="sp-avatar-hero">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="flex justify-center gap-1 mt-2 mb-1">
                        <div class="w-3 h-3 rounded-full bg-slate-700" id="sp-p1-s1"></div>
                        <div class="w-3 h-3 rounded-full bg-slate-700" id="sp-p1-s2"></div>
                        <div class="w-3 h-3 rounded-full bg-slate-700" id="sp-p1-s3"></div>
                    </div>
                    <div class="bg-black/60 px-2 rounded text-cyan-300 font-bold" id="sp-name-hero">Hero</div>
                </div>
                <div class="relative text-center">
                    <div class="w-48 h-4 bg-slate-800 rounded border border-slate-600 mb-2 overflow-hidden"><div id="sp-hp-enemy" class="h-full bg-red-500 w-full health-fill"></div></div>
                    <div class="text-9xl filter drop-shadow-[0_0_20px_red] enemy-idle scale-x-[-1]" id="sp-emoji-enemy">üëæ</div>
                    <div class="bg-black/60 px-2 rounded text-red-400 font-bold mt-2" id="sp-name-enemy">Bug</div>
                </div>
            </div>

            <!-- Multi View -->
            <div id="view-multi" class="hidden w-full h-full grid grid-cols-2 relative z-10">
                <div class="flex flex-col items-center justify-center border-r border-slate-800/50 bg-gradient-to-r from-cyan-900/10 to-transparent">
                    <div class="w-64 h-6 bg-slate-800 rounded border border-slate-600 mb-4 overflow-hidden relative">
                        <div id="mp-hp-p1" class="h-full bg-cyan-500 w-full health-fill"></div>
                        <span class="absolute inset-0 flex items-center justify-center text-xs font-bold drop-shadow">HP</span>
                    </div>
                    <div class="text-[150px] filter drop-shadow-[0_0_30px_cyan] hero-float" id="mp-avatar-p1">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="flex justify-center gap-1 mt-4 mb-1">
                        <div class="w-4 h-4 rounded-full bg-slate-700 border border-slate-500" id="mp-p1-s1"></div>
                        <div class="w-4 h-4 rounded-full bg-slate-700 border border-slate-500" id="mp-p1-s2"></div>
                        <div class="w-4 h-4 rounded-full bg-slate-700 border border-slate-500" id="mp-p1-s3"></div>
                    </div>
                    <h3 class="text-2xl font-moba text-cyan-400" id="mp-name-p1">PLAYER 1</h3>
                </div>
                <div class="flex flex-col items-center justify-center bg-gradient-to-l from-red-900/10 to-transparent">
                    <div class="w-64 h-6 bg-slate-800 rounded border border-slate-600 mb-4 overflow-hidden relative">
                        <div id="mp-hp-p2" class="h-full bg-red-500 w-full health-fill"></div>
                        <span class="absolute inset-0 flex items-center justify-center text-xs font-bold drop-shadow">HP</span>
                    </div>
                    <div class="text-[150px] filter drop-shadow-[0_0_30px_red] hero-float scale-x-[-1] hue-rotate-[140deg]" id="mp-avatar-p2">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="flex justify-center gap-1 mt-4 mb-1">
                        <div class="w-4 h-4 rounded-full bg-slate-700 border border-slate-500" id="mp-p2-s1"></div>
                        <div class="w-4 h-4 rounded-full bg-slate-700 border border-slate-500" id="mp-p2-s2"></div>
                        <div class="w-4 h-4 rounded-full bg-slate-700 border border-slate-500" id="mp-p2-s3"></div>
                    </div>
                    <h3 class="text-2xl font-moba text-red-500" id="mp-name-p2">PLAYER 2</h3>
                </div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="relative z-30 min-h-[300px] bg-slate-900 border-t-4 border-slate-700 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] flex flex-col">
            <div class="bg-slate-800 border-b border-slate-700 p-4 min-h-[80px] flex items-center justify-center">
                <p id="question-text" class="text-center text-xl md:text-2xl font-medium text-white max-w-4xl leading-relaxed">Loading...</p>
            </div>
            <div class="flex-grow relative">
                <!-- SINGLE CONTROLS -->
                <div id="controls-single" class="hidden w-full h-full flex flex-col items-center justify-center gap-4 p-6">
                    <button id="btn-ult-p1-single" onclick="castUltimate('p1')" class="ult-btn w-full max-w-2xl h-16 rounded-lg font-bold text-white text-xl tracking-[0.2em] shadow-lg mb-2">
                        <i class="fas fa-bolt mr-2"></i> THUNDER STRIKE
                    </button>
                    <div id="options-single" class="flex gap-4 w-full max-w-4xl justify-center"></div>
                </div>
                <!-- MULTI CONTROLS -->
                <div id="controls-multi" class="hidden w-full h-full grid grid-cols-2">
                    <div class="p-4 flex flex-col items-center justify-center border-r border-slate-700 bg-slate-900">
                        <button id="btn-ult-p1-multi" onclick="castUltimate('p1')" class="ult-btn w-full max-w-md h-12 rounded font-bold text-white text-lg tracking-widest shadow-lg mb-4">
                            <i class="fas fa-bolt mr-2"></i> THUNDER STRIKE
                        </button>
                        <div class="text-cyan-500 font-bold mb-2 text-sm tracking-widest">PLAYER 1 CONTROLS</div>
                        <div id="p1-buttons" class="grid grid-cols-3 gap-3 w-full max-w-md"></div>
                    </div>
                    <div class="p-4 flex flex-col items-center justify-center bg-slate-900">
                        <button id="btn-ult-p2-multi" onclick="castUltimate('p2')" class="ult-btn w-full max-w-md h-12 rounded font-bold text-white text-lg tracking-widest shadow-lg mb-4">
                            <i class="fas fa-meteor mr-2"></i> METEOR BLAST
                        </button>
                        <div class="text-red-500 font-bold mb-2 text-sm tracking-widest">PLAYER 2 CONTROLS</div>
                        <div id="p2-buttons" class="grid grid-cols-3 gap-3 w-full max-w-md"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="screen-end" class="hidden absolute z-50 inset-0 bg-slate-950/95 flex flex-col items-center justify-center text-center p-8">
        <h1 id="end-title" class="text-7xl font-moba mb-4">GAME OVER</h1>
        <p id="end-desc" class="text-2xl text-slate-300 mb-8 max-w-2xl">...</p>
        <p id="save-status" class="text-sm text-yellow-400 mt-4 animate-pulse"></p>
        <button onclick="location.reload()" class="px-10 py-4 bg-blue-600 rounded font-bold text-xl hover:bg-blue-500 mt-4">MAIN LAGI</button>
    </div>

    <script>
        // --- CONFIG ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyia_axLMWaHEBu6lO-R7nM63Je7N-LqHyPaIVjgmn3pDkxB9tZupd8mG_ARI6CzBdUKA/exec";
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1Ldnwb_vDuTiRu341jOIZdUmM5Z3eBbliMVjVLRl1NMo/edit?usp=sharing"; 

        // Dynamic Backgrounds for Arenas
        const arenaBackgrounds = [
            "https://images.unsplash.com/photo-1480796927426-f609979314bd?q=80&w=2000", // City (Class/Obj)
            "https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?q=80&w=2000", // Matrix (Encapsulation)
            "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2000", // Circuit (Inheritance)
            "https://images.unsplash.com/photo-1534972195531-d756b9bfa9f2?q=80&w=2000"  // Nebula (Polymorphism)
        ];

        // FALLBACK DATA (Full Game Content)
        const defaultArenas = [
            { 
                title: "Class & Object", 
                briefing: "CLASS = CETAKAN (Blueprint). OBJECT = HASIL NYATA. Gunakan keyword 'new' untuk menciptakan object dari class.",
                questions: [
                    { q: "Apa blueprint untuk membuat objek?", opts: [{l:"Class", c:true}, {l:"Method", c:false}, {l:"Package", c:false}] },
                    { q: "Keyword untuk instansiasi objek?", opts: [{l:"new", c:true}, {l:"make", c:false}, {l:"create", c:false}] }
                ]
            },
            { 
                title: "Encapsulation", 
                briefing: "LINDUNGI DATA SENSITIF. Gunakan 'private' untuk menyembunyikan data.",
                questions: [
                    { q: "Akses modifier paling ketat?", opts: [{l:"private", c:true}, {l:"public", c:false}, {l:"protected", c:false}] }
                ]
            }
        ];

        let arenas = []; 

        // --- ADMIN LOGIN ---
        function adminLogin() {
            const pass = prompt("Masukkan Password Admin:");
            if (pass === "admin123") {
                window.open(GOOGLE_SHEET_URL, '_blank');
            } else if (pass) {
                alert("Password Salah!");
            }
        }

        // --- FETCH DATA ---
        async function initGameData() {
            const statusEl = document.getElementById('loading-status');
            const connIndicator = document.getElementById('connection-indicator');
            const connDot = document.getElementById('conn-dot');
            const connText = document.getElementById('conn-text');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 

            try {
                if(!GOOGLE_SCRIPT_URL) throw new Error("No URL");
                
                const response = await fetch(GOOGLE_SCRIPT_URL, { 
                    signal: controller.signal,
                    credentials: 'omit' // Prevent cookie issues
                });
                
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") === -1) {
                    throw new Error("Permission Error");
                }

                const data = await response.json();
                
                if (data.error) throw new Error("Server Error: " + data.error);

                if (Array.isArray(data) && data.length > 0) {
                    arenas = data;
                    statusEl.innerText = "Data Loaded Successfully!";
                    statusEl.classList.add('text-green-400');
                    connDot.classList.replace('bg-yellow-500', 'bg-green-500');
                    connText.innerText = "ONLINE";
                    connText.classList.replace('text-slate-300', 'text-green-300');
                    setTimeout(() => {
                        document.getElementById('screen-loading').classList.add('hidden');
                        document.getElementById('screen-mode').classList.remove('hidden');
                    }, 1000);
                } else {
                    throw new Error("Empty Data");
                }
            } catch (err) {
                console.warn("Using Offline Data:", err); 
                statusEl.innerText = "Offline Mode: " + err.message;
                statusEl.classList.add('text-red-400');
                connDot.classList.replace('bg-yellow-500', 'bg-red-500');
                connText.innerText = "OFFLINE MODE";
                connText.classList.replace('text-slate-300', 'text-red-300');
                arenas = defaultArenas; 
                setTimeout(() => {
                    document.getElementById('screen-loading').classList.add('hidden');
                    document.getElementById('screen-mode').classList.remove('hidden');
                }, 1500);
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // --- SAVE SCORE ---
        function saveScoreToCloud(winnerName) {
            if (!GOOGLE_SCRIPT_URL) return;
            const statusEl = document.getElementById('save-status');
            statusEl.innerText = "Menyimpan Data Skor...";
            const payload = {
                mode: state.mode,
                p1Name: state.p1.name,
                p1Score: state.p1.score,
                p2Name: state.p2.name,
                p2Score: state.p2.score,
                winner: winnerName
            };
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors", 
                headers: { "Content-Type": "text/plain" }, 
                body: JSON.stringify(payload)
            }).then(() => {
                statusEl.innerText = "Data Berhasil Disimpan!";
                statusEl.classList.replace('text-yellow-400', 'text-green-400');
            }).catch(err => {
                console.error(err);
                statusEl.innerText = "Gagal Menyimpan Data";
                statusEl.classList.replace('text-yellow-400', 'text-red-400');
            });
        }

        // --- FETCH LEADERBOARD ---
        function showLeaderboard() {
            document.getElementById('screen-mode').classList.add('hidden');
            document.getElementById('screen-leaderboard').classList.remove('hidden');
            fetchRankData('single');
        }

        async function fetchRankData(mode) {
            const tbody = document.getElementById('leaderboard-body');
            const tabSingle = document.getElementById('tab-single');
            const tabMulti = document.getElementById('tab-multi');
            const subtitle = document.getElementById('leaderboard-subtitle');

            if (mode === 'single') {
                tabSingle.classList.add('active-single'); tabMulti.classList.remove('active-multi');
                subtitle.innerText = "Top Solo Players (High Score)";
            } else {
                tabMulti.classList.add('active-multi'); tabSingle.classList.remove('active-single');
                subtitle.innerText = "Top PvP Duelists (High Score)";
            }

            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8">Fetching Data...</td></tr>';

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + "?action=leaderboard&mode=" + mode);
                const data = await response.json();
                
                tbody.innerHTML = '';
                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-slate-500">Belum ada data untuk mode ini.</td></tr>';
                    return;
                }

                data.forEach((player, index) => {
                    let rankClass = "text-slate-300";
                    if(index === 0) rankClass = "rank-1 font-bold text-xl text-yellow-400 drop-shadow-md";
                    else if(index === 1) rankClass = "rank-2 font-bold text-lg text-gray-300";
                    else if(index === 2) rankClass = "rank-3 font-bold text-orange-400";

                    let dateStr = player.date;
                    try {
                        const dateObj = new Date(player.date);
                        dateStr = dateObj.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' });
                    } catch(e) {}

                    const row = `
                        <tr class="leaderboard-row">
                            <td class="leaderboard-cell text-center ${rankClass}">#${index + 1}</td>
                            <td class="leaderboard-cell font-bold text-white">${player.name}</td>
                            <td class="leaderboard-cell text-right font-mono text-cyan-400">${player.score}</td>
                            <td class="leaderboard-cell text-right text-xs text-slate-500">${dateStr}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-red-400">Gagal mengambil data. Cek koneksi.</td></tr>';
            }
        }

        function hideLeaderboard() {
            document.getElementById('screen-leaderboard').classList.add('hidden');
            document.getElementById('screen-mode').classList.remove('hidden');
        }

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMuted = false;
        let isMusicPlaying = false; 

        const BGM = {
            oscillators: [],
            gainNode: null,
            isPlaying: false,
            init: function() {
                if(this.isPlaying) return;
                this.isPlaying = true;
                this.gainNode = audioCtx.createGain();
                this.gainNode.gain.value = 0.1;
                this.gainNode.connect(audioCtx.destination);
                this.createDrone(55, 'sawtooth', 0.8);
                this.createDrone(55.5, 'sawtooth', 0.6); 
                this.createDrone(82.4, 'triangle', 0.4);
            },
            createDrone: function(freq, type, vol) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();
                osc.type = type; osc.frequency.value = freq;
                filter.type = 'lowpass'; filter.frequency.value = 200; filter.Q.value = 1;
                gain.gain.value = vol;
                const lfo = audioCtx.createOscillator();
                lfo.type = 'sine'; lfo.frequency.value = 0.1;
                const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 100;
                lfo.connect(lfoGain); lfoGain.connect(filter.frequency); lfo.start();
                osc.connect(filter); filter.connect(gain); gain.connect(this.gainNode);
                osc.start(); this.oscillators.push({ osc, lfo, gain });
            },
            stop: function() {
                if(!this.isPlaying) return;
                this.oscillators.forEach(o => { o.osc.stop(); o.lfo.stop(); o.osc.disconnect(); });
                this.oscillators = []; this.gainNode.disconnect(); this.isPlaying = false;
            },
            setVolume: function(val) {
                if(this.gainNode) this.gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.5);
            }
        };

        function toggleMusic() {
            isMusicPlaying = !isMusicPlaying;
            const btn = document.getElementById('bgm-btn');
            if(isMusicPlaying) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                BGM.init(); BGM.setVolume(0.1);
                btn.innerHTML = '<i class="fas fa-music text-green-400"></i>';
            } else {
                BGM.stop();
                btn.innerHTML = '<i class="fas fa-music text-slate-400"></i>';
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if(isMuted) {
                btn.innerHTML = '<i class="fas fa-volume-mute text-red-500"></i>';
            } else {
                btn.innerHTML = '<i class="fas fa-volume-up text-cyan-400"></i>';
                if(audioCtx.state === 'suspended') audioCtx.resume();
            }
        }

        function playTone(freq, type, duration, vol=0.1) {
            if(isMuted) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function playNoise(duration) {
            if(isMuted) return;
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            noise.connect(gain); gain.connect(audioCtx.destination);
            noise.start();
        }

        const sfx = {
            select: () => playTone(800, 'sine', 0.1),
            correct: () => { playTone(600, 'square', 0.1); setTimeout(()=>playTone(1200, 'square', 0.2), 100); },
            wrong: () => { playTone(150, 'sawtooth', 0.3); setTimeout(()=>playTone(100, 'sawtooth', 0.3), 150); },
            attack: () => { 
                if(isMuted) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            },
            ult: () => { playNoise(1.0); playTone(50, 'sawtooth', 1.0, 0.2); },
            win: () => { [440, 554, 659, 880].forEach((f, i) => setTimeout(() => playTone(f, 'square', 0.3), i*200)); }
        };

        // --- AVATAR DATA ---
        const avatars = ["üßô‚Äç‚ôÇÔ∏è", "ü§ñ", "ü•∑", "üëΩ"];

        let state = { 
            mode: 'single', 
            p1: { name: "Hero", hp: 100, score: 0, streak: 0, ultReady: false, avatar: avatars[0], avatarIdx: 0 }, 
            p2: { name: "Rival", hp: 100, score: 0, streak: 0, ultReady: false, avatar: avatars[0], avatarIdx: 0 }, 
            arenaIdx: 0, qIdx: 0, canAnswer: true 
        };
        
        let timerInterval;
        let briefingTimer;
        const TIME_LIMIT = 20;
        let timeLeft = TIME_LIMIT;

        // --- CHARACTER SELECTION LOGIC ---
        function selectAvatar(playerKey, idx) {
            sfx.select();
            state[playerKey].avatarIdx = idx;
            state[playerKey].avatar = avatars[idx];
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`${playerKey}-char-${i}`);
                if(btn) {
                    if(i === idx) btn.classList.add(`selected-${playerKey}`);
                    else btn.classList.remove(`selected-${playerKey}`);
                }
            }
        }

        // --- TIMER ---
        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = TIME_LIMIT;
            updateTimerVisuals();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerVisuals();
                if (timeLeft <= 0) handleTimeOut();
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }
        function updateTimerVisuals() {
            document.getElementById('timer-text').innerText = timeLeft;
            const circle = document.querySelector('.timer-circle');
            const circumference = 283;
            const offset = circumference - (timeLeft / TIME_LIMIT) * circumference;
            circle.style.strokeDashoffset = offset;
            if (timeLeft > 10) { circle.style.stroke = "#22c55e"; circle.style.animation = "none"; }
            else if (timeLeft > 5) { circle.style.stroke = "#eab308"; circle.style.animation = "none"; }
            else { circle.style.stroke = "#ef4444"; circle.style.animation = "urgentPulse 0.5s infinite"; }
        }
        function handleTimeOut() {
            stopTimer();
            state.canAnswer = false;
            sfx.wrong();
            if (state.mode === 'single') {
                showFloatText("TIME OUT!", 'view-single', 'text-red-500');
                state.p1.hp -= 15;
            } else {
                showFloatText("SUDDEN DEATH!", 'view-multi', 'text-yellow-500');
                state.p1.hp -= 10; state.p2.hp -= 10;
            }
            resetStreak('p1'); resetStreak('p2');
            updateHP(); checkDeathOrNext();
        }

        // --- SETUP ---
        function selectMode(mode) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            sfx.select();
            state.mode = mode;
            document.getElementById('screen-mode').classList.add('hidden');
            document.getElementById('screen-input').classList.remove('hidden');
            document.getElementById('screen-input').classList.add('flex');
            selectAvatar('p1', 0);
            selectAvatar('p2', 0);
            if(mode === 'multi') document.getElementById('p2-input-group').classList.remove('hidden');
        }

        function startGame() {
            sfx.select();
            state.p1.name = document.getElementById('input-p1').value || "Player 1";
            state.p2.name = (state.mode === 'multi') ? (document.getElementById('input-p2').value || "Player 2") : "Bug Lord";
            document.getElementById('screen-input').classList.add('hidden');
            if(!isMusicPlaying) toggleMusic(); 
            showBriefing();
        }

        function showBriefing() {
            sfx.select();
            const arena = arenas[state.arenaIdx];
            document.getElementById('game-interface').classList.add('hidden');
            document.getElementById('screen-briefing').classList.remove('hidden');
            document.getElementById('screen-briefing').classList.add('flex');
            
            // Set dynamic background for the arena
            const bgUrl = arenaBackgrounds[state.arenaIdx % arenaBackgrounds.length];
            document.getElementById('arena-bg').style.backgroundImage = `url('${bgUrl}')`;
            
            document.getElementById('briefing-title').innerText = arena.title;
            document.getElementById('briefing-desc').innerText = arena.briefing;
            
            let bTime = 8;
            document.getElementById('briefing-countdown').innerText = bTime;
            document.getElementById('briefing-timer-bar').style.width = '100%';
            
            if(briefingTimer) clearInterval(briefingTimer);
            briefingTimer = setInterval(() => {
                bTime--;
                document.getElementById('briefing-countdown').innerText = bTime;
                document.getElementById('briefing-timer-bar').style.width = (bTime/8 * 100) + '%';
                if(bTime <= 0) endBriefing();
            }, 1000);
        }

        function endBriefing() {
            clearInterval(briefingTimer);
            document.getElementById('screen-briefing').classList.add('hidden');
            document.getElementById('screen-briefing').classList.remove('flex');
            document.getElementById('game-interface').classList.remove('hidden');
            document.getElementById('game-interface').classList.add('flex');
            
            // Reset overlay visibility (Fix stuck overlay)
            document.getElementById('low-hp-overlay-p1').classList.add('hidden');
            document.getElementById('low-hp-overlay-p2').classList.add('hidden');

            if (state.mode === 'single') {
                document.getElementById('view-single').classList.remove('hidden');
                document.getElementById('controls-single').classList.remove('hidden');
                document.getElementById('controls-single').classList.add('flex');
                document.getElementById('p2-score-container').classList.add('invisible');
                document.getElementById('sp-name-hero').innerText = state.p1.name;
                document.getElementById('sp-avatar-hero').innerText = state.p1.avatar;
                document.getElementById('sp-name-enemy').innerText = state.p2.name;
            } else {
                document.getElementById('view-multi').classList.remove('hidden');
                document.getElementById('controls-multi').classList.remove('hidden');
                document.getElementById('p2-score-container').classList.remove('invisible');
                document.getElementById('mp-name-p1').innerText = state.p1.name;
                document.getElementById('mp-avatar-p1').innerText = state.p1.avatar;
                document.getElementById('mp-name-p2').innerText = state.p2.name;
                document.getElementById('mp-avatar-p2').innerText = state.p2.avatar;
            }
            showArenaBanner();
            loadLevel();
        }

        function showArenaBanner() {
            const banner = document.getElementById('arena-banner');
            document.getElementById('arena-banner-text').innerText = arenas[state.arenaIdx].title;
            banner.style.animation = 'none';
            banner.offsetHeight; 
            banner.style.animation = 'arenaFade 3s forwards';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadLevel() {
            if (state.arenaIdx >= arenas.length) { endGame(true); return; }
            const q = arenas[state.arenaIdx].questions[state.qIdx];
            document.getElementById('arena-name').innerText = arenas[state.arenaIdx].title;
            document.getElementById('question-text').innerText = q.q;
            state.canAnswer = true;
            renderControls(shuffleArray([...q.opts]));
            updateUltButtons(); 
            startTimer(); 
        }

        function renderControls(options) {
            const createBtn = (opt, playerPrefix, colorClass) => `
                <button onclick="handleAnswer('${playerPrefix}', ${opt.c}, this)" 
                    class="skill-btn w-full h-24 rounded-lg flex flex-col items-center justify-center group relative hover:bg-slate-800 active:scale-95 transition-all">
                    <span class="text-xl md:text-2xl font-bold ${colorClass} mb-1 group-hover:text-white">${opt.l}</span>
                </button>`;

            if (state.mode === 'single') {
                document.getElementById('options-single').innerHTML = options.map(o => createBtn(o, 'p1', 'text-cyan-400')).join('');
            } else {
                document.getElementById('p1-buttons').innerHTML = options.map(o => createBtn(o, 'p1', 'text-cyan-400')).join('');
                document.getElementById('p2-buttons').innerHTML = options.map(o => createBtn(o, 'p2', 'text-red-500')).join('');
            }
        }

        // --- GAME LOGIC ---
        function handleAnswer(playerKey, isCorrect, btn) {
            if (!state.canAnswer) return;
            stopTimer();
            if (state.mode === 'single') handleSingle(isCorrect, btn);
            else handleMulti(playerKey, isCorrect, btn);
        }

        function handleSingle(isCorrect, btn) {
            state.canAnswer = false;
            if (isCorrect) {
                sfx.correct();
                playAttackAnim(true);
                incrementStreak('p1');
                btn.classList.add('bg-green-900', 'border-green-500');
                setTimeout(() => {
                    showFloatText("CRITICAL!", 'view-single', 'text-yellow-400');
                    state.p1.score += 100; state.p2.hp -= 34;
                    updateHP(); checkDeathOrNext();
                }, 400);
            } else {
                sfx.wrong();
                playAttackAnim(false);
                resetStreak('p1');
                btn.classList.add('bg-red-900', 'border-red-500');
                setTimeout(() => {
                    showFloatText("MISS!", 'view-single', 'text-red-500');
                    state.p1.hp -= 20;
                    updateHP(); checkDeathOrNext();
                }, 400);
            }
            updateScores();
        }

        function handleMulti(playerKey, isCorrect, btn) {
            state.canAnswer = false;
            const isP1 = playerKey === 'p1';
            const opponentKey = isP1 ? 'p2' : 'p1';
            
            if (isCorrect) {
                sfx.correct();
                playAttackAnim(isP1);
                incrementStreak(playerKey);
                btn.style.backgroundColor = isP1 ? 'rgba(6,182,212,0.3)' : 'rgba(239,68,68,0.3)';
                setTimeout(() => {
                    state[opponentKey].hp -= 25; state[playerKey].score += 100;
                    showFloatText("HIT!", 'view-multi', isP1 ? 'text-cyan-400' : 'text-red-400');
                    updateHP(); updateScores(); checkDeathOrNext();
                }, 400);
            } else {
                sfx.wrong();
                btn.style.backgroundColor = '#450a0a';
                resetStreak(playerKey);
                state[playerKey].hp -= 15;
                showFloatText("BACKFIRE!", 'view-multi', 'text-yellow-500');
                updateHP(); updateScores(); checkDeathOrNext();
            }
        }

        // --- STREAK & ULT ---
        function incrementStreak(playerKey) {
            const player = state[playerKey];
            if (player.ultReady) return; 
            player.streak++;
            updateStreakVisuals(playerKey);
            if (player.streak >= 3) {
                player.ultReady = true;
                sfx.select(); 
                showFloatText("ULTIMATE READY!", state.mode === 'single' ? 'view-single' : 'view-multi', playerKey === 'p1' ? 'text-cyan-300' : 'text-red-300');
                updateUltButtons();
            }
        }
        function resetStreak(playerKey) {
            state[playerKey].streak = 0;
            updateStreakVisuals(playerKey);
        }
        function updateStreakVisuals(playerKey) {
            const s = state[playerKey].streak;
            const prefix = state.mode === 'single' ? 'sp' : 'mp';
            if (state.mode === 'single' && playerKey === 'p2') return;
            for(let i=1; i<=3; i++) {
                const dot = document.getElementById(`${prefix}-${playerKey}-s${i}`);
                if(dot) {
                    if(i <= s) dot.classList.replace('bg-slate-700', playerKey === 'p1' ? 'bg-cyan-400' : 'bg-red-500');
                    else dot.classList.replace(playerKey === 'p1' ? 'bg-cyan-400' : 'bg-red-500', 'bg-slate-700');
                    if(i <= s) dot.classList.add('shadow-[0_0_10px_currentColor]');
                    else dot.classList.remove('shadow-[0_0_10px_currentColor]');
                }
            }
        }
        function updateUltButtons() {
            const btnP1S = document.getElementById('btn-ult-p1-single');
            const btnP1M = document.getElementById('btn-ult-p1-multi');
            const btnP2M = document.getElementById('btn-ult-p2-multi');
            const toggle = (btn, ready) => {
                if(!btn) return;
                btn.disabled = !ready;
                if(ready) btn.classList.add('ready'); else btn.classList.remove('ready');
            };
            if (state.mode === 'single') toggle(btnP1S, state.p1.ultReady);
            else { toggle(btnP1M, state.p1.ultReady); toggle(btnP2M, state.p2.ultReady); }
        }
        window.castUltimate = function(playerKey) {
            const player = state[playerKey];
            if (!player.ultReady) return;
            sfx.ult();
            stopTimer(); state.canAnswer = false; 
            player.streak = 0; player.ultReady = false;
            updateStreakVisuals(playerKey); updateUltButtons();
            const overlay = document.getElementById('ult-overlay');
            const battlefield = document.getElementById('battlefield');
            const opponentKey = playerKey === 'p1' ? 'p2' : 'p1';
            const isP1 = playerKey === 'p1';
            overlay.classList.remove('hidden');
            overlay.style.animation = isP1 ? 'thunder-flash 1s' : 'meteor-flash 1s';
            battlefield.style.animation = 'screen-shake 0.5s';
            setTimeout(() => {
                overlay.style.animation = ''; overlay.classList.add('hidden'); battlefield.style.animation = '';
                const dmg = 50;
                state[opponentKey].hp -= dmg;
                showFloatText(isP1 ? "THUNDER STRIKE!" : "METEOR BLAST!", state.mode === 'single' ? 'view-single' : 'view-multi', isP1 ? 'text-yellow-300' : 'text-orange-400');
                updateHP(); checkDeathOrNext(); 
            }, 1000);
        };

        // --- HELPERS ---
        function playAttackAnim(isP1) {
            sfx.attack();
            const el = document.getElementById(isP1 ? 'proj-p1' : 'proj-p2');
            el.style.display = 'block';
            el.style.animation = `${isP1 ? 'shoot-p1' : 'shoot-p2'} 0.5s forwards linear`;
            setTimeout(() => el.style.display = 'none', 500);
        }
        function checkDeathOrNext() {
            if (state.mode === 'single') {
                if (state.p1.hp <= 0) {
                    setTimeout(() => endGame(false), 1000);
                    return;
                }
                if (state.p2.hp <= 0) {
                    state.p2.hp = 0;
                    setTimeout(() => {
                        state.arenaIdx++;
                        state.qIdx = 0;
                        state.p2.hp = 100;
                        if (state.arenaIdx >= arenas.length) {
                            endGame(true);
                        } else {
                            showBriefing();
                        }
                    }, 1000);
                    return;
                }
            } else {
                if (state.p1.hp <= 0 || state.p2.hp <= 0) {
                    setTimeout(() => endGameMulti(), 1000);
                    return;
                }
            }
            setTimeout(() => nextQuestion(), 1000);
        }
        
        function updateHP() {
            // Helper for critical health
            const checkCritical = (hp, overlayId) => {
                const el = document.getElementById(overlayId);
                // In Single Player, P1 takes full screen overlay
                if (state.mode === 'single' && overlayId === 'low-hp-overlay-p1') {
                    if (hp > 0 && hp <= 30) {
                        el.classList.remove('hidden', 'w-1/2'); // Remove w-1/2
                        el.classList.add('w-full'); // Make full width
                    } else {
                        el.classList.add('hidden');
                    }
                } else {
                    // Multiplayer logic stays split
                    if (hp > 0 && hp <= 30) {
                        el.classList.remove('hidden');
                        el.classList.add(overlayId === 'low-hp-overlay-p1' ? 'left-0' : 'right-0');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            };

            if (state.mode === 'single') {
                 document.getElementById('sp-hp-hero').style.width = Math.max(0, state.p1.hp) + "%";
                 document.getElementById('sp-hp-enemy').style.width = Math.max(0, state.p2.hp) + "%";
                 checkCritical(state.p1.hp, 'low-hp-overlay-p1');
            } else {
                 document.getElementById('mp-hp-p1').style.width = Math.max(0, state.p1.hp) + "%";
                 document.getElementById('mp-hp-p2').style.width = Math.max(0, state.p2.hp) + "%";
                 checkCritical(state.p1.hp, 'low-hp-overlay-p1');
                 checkCritical(state.p2.hp, 'low-hp-overlay-p2');
            }
        }
        function updateScores() {
            document.getElementById('score-p1').innerText = state.p1.score;
            document.getElementById('score-p2').innerText = state.p2.score;
        }
        function nextQuestion() {
            state.qIdx++;
            if (state.qIdx >= arenas[state.arenaIdx].questions.length) {
                state.arenaIdx++; state.qIdx = 0;
                if (state.mode === 'single') state.p2.hp = 100; 
                if (state.arenaIdx < arenas.length) showBriefing();
                else loadLevel();
            } else loadLevel();
        }
        function showFloatText(txt, containerId, colorClass) {
            const el = document.createElement('div');
            el.innerText = txt;
            el.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl md:text-7xl font-moba font-bold ${colorClass} drop-shadow-[0_0_10px_black] z-50 whitespace-nowrap`;
            el.style.animation = "damagePopup 1.5s forwards";
            document.getElementById('combat-text-container').appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }
        function endGame(isWin) {
            BGM.stop();
            sfx.win();
            document.getElementById('game-interface').classList.add('hidden');
            document.getElementById('screen-end').classList.remove('hidden');
            
            // Set Avatar Reaction
            const emoji = isWin ? "üèÜ" : "‚ò†Ô∏è";
            document.getElementById('end-title').innerHTML = `${emoji} ${isWin ? "VICTORY!" : "GAME OVER"}`;
            
            document.getElementById('end-title').className = `text-7xl font-moba mb-4 ${isWin ? 'text-cyan-400' : 'text-red-500'}`;
            document.getElementById('end-desc').innerText = isWin ? "Anda telah menguasai semua arena." : "Logika Anda error. Coba lagi!";
            
            const winnerName = isWin ? state.p1.name : "Bug Lord";
            saveScoreToCloud(winnerName);
        }
        function endGameMulti() {
            BGM.stop();
            sfx.win();
            document.getElementById('game-interface').classList.add('hidden');
            document.getElementById('screen-end').classList.remove('hidden');
            const p1Win = state.p1.hp > 0;
            const winner = p1Win ? state.p1.name : state.p2.name;
            const emoji = "üëë";
            
            document.getElementById('end-title').innerHTML = `${emoji} WINNER!`;
            document.getElementById('end-title').className = `text-7xl font-moba mb-4 ${p1Win ? 'text-cyan-400' : 'text-red-500'}`;
            document.getElementById('end-desc').innerText = `Selamat ${winner}!\nCoding Master Sejati.`;
            
            saveScoreToCloud(winner);
        }
    </script>
</body>
</html>